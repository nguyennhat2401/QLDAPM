{% extends 'layout/base.html' %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4 text-center fw-bold text-primary">Danh sách Khóa học</h2>

  {# Phân trang #}
  {% if pages > 1 %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mb-4">
      {% for i in range(1, pages + 1) %}
      <li class="page-item {% if i == (page|default(1)) %}active{% endif %}">
        <a class="page-link" href="/?page={{ i }}">{{ i }}</a>
      </li>
      {% endfor %}
    </ul>
  </nav>
  {% endif %}

  <div class="row g-4">
    {% for c in courses %}
    <div class="col-md-3 col-sm-6">
      <div class="card h-100 shadow-sm border-0 rounded-3">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title fw-bold text-dark">{{ c.title }}</h5>
          <p class="card-text small text-muted flex-grow-1">
            {{ (c.description or '')[:60] }}{% if c.description %}...{% endif %}
          </p>
          <p class="fw-bold text-success mb-2">
            {{ "{:,.0f}".format(c.price or 0) }} VND
          </p>

          {% set balance = user_balance | default(0, true) %}
          {% if not c.purchased %}
            <button
              class="btn btn-primary w-100 mt-auto buy-btn"
              data-course-id="{{ c.id }}"
              data-course-title="{{ c.title }}"
              data-course-price="{{ c.price or 0 }}"
              data-user-balance="{{ balance }}"
              data-open-url="{{ url_for('open_course', course_id=c.id) }}"
            >
              Mua ngay
            </button>
          {% else %}
            <a href="{{ url_for('open_course', course_id=c.id) }}"
               class="btn btn-outline-primary w-100 mt-auto">
              Xem chi tiết
            </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

{# Modal xác nhận mua dùng chung #}
<div class="modal fade" id="confirmBuyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Xác nhận mua khóa học</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn mua khóa học <strong id="cb-title"></strong>?</p>
        <div class="d-flex justify-content-between">
          <span>Giá khóa học</span><strong id="cb-price"></strong>
        </div>
        <div class="d-flex justify-content-between mt-1">
          <span>Số dư hiện tại</span><strong id="cb-balance"></strong>
        </div>
        <div id="cb-alert" class="alert mt-3 d-none"></div>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('topup') }}" id="cb-topup" class="btn btn-outline-secondary d-none">Nạp tiền</a>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="cb-confirm" disabled>Xác nhận mua</button>
      </div>
    </div>
  </div>
</div>

{# JS điều khiển modal #}
<script>
(function(){
  function fmt(n){ try { return Number(n).toLocaleString('vi-VN'); } catch { return n; } }

  const modalEl = document.getElementById('confirmBuyModal');
  const modal = new bootstrap.Modal(modalEl);
  const elTitle = document.getElementById('cb-title');
  const elPrice = document.getElementById('cb-price');
  const elBalance = document.getElementById('cb-balance');
  const elAlert = document.getElementById('cb-alert');
  const btnConfirm = document.getElementById('cb-confirm');
  const btnTopup = document.getElementById('cb-topup');

  let current = { openUrl: null };

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.buy-btn');
    if (!btn) return;

    const title = btn.dataset.courseTitle || '';
    const price = parseFloat(btn.dataset.coursePrice || '0');
    const balance = parseFloat(btn.dataset.userBalance || '0');
    const openUrl = btn.dataset.openUrl;

    elTitle.textContent = title;
    elPrice.textContent = fmt(price) + ' đ';
    elBalance.textContent = fmt(balance) + ' đ';

    elAlert.classList.add('d-none');
    elAlert.classList.remove('alert-success', 'alert-warning');
    btnConfirm.disabled = true;
    btnTopup.classList.add('d-none');

    if (balance < price) {
      elAlert.textContent = 'Số dư không đủ. Vui lòng nạp thêm để tiếp tục.';
      elAlert.classList.remove('d-none');
      elAlert.classList.add('alert', 'alert-warning');
      btnConfirm.disabled = true;
      btnTopup.classList.remove('d-none');
    } else {
      elAlert.textContent = 'Bạn đủ số dư để mua khóa học này.';
      elAlert.classList.remove('d-none');
      elAlert.classList.add('alert', 'alert-success');
      btnConfirm.disabled = false;
    }

    current.openUrl = openUrl;
    modal.show();
  });

  btnConfirm.addEventListener('click', () => {
    if (!current.openUrl) return;
    window.location.href = current.openUrl;
  });
})();
</script>
{% endblock %}
